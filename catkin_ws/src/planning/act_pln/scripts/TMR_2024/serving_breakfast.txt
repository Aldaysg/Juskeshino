#!/usr/bin/env python3
import rospy
import rospkg
import time
import numpy as np
from juskeshino_tools.JuskeshinoNavigation import JuskeshinoNavigation
from juskeshino_tools.JuskeshinoVision import JuskeshinoVision
from juskeshino_tools.JuskeshinoHardware import JuskeshinoHardware
from juskeshino_tools.JuskeshinoSimpleTasks import JuskeshinoSimpleTasks
from juskeshino_tools.JuskeshinoHRI import JuskeshinoHRI
from juskeshino_tools.JuskeshinoManipulation import JuskeshinoManipulation
from juskeshino_tools.JuskeshinoKnowledge import JuskeshinoKnowledge

HOME              = [0,0,0,0,0,0,0]
PREPARE           = [-0.69, 0.2, 0.0, 1.55, 0.0, 1.16, 0.0]
PREPARE_LATERAL_GRIP = [-0.69, 0.2, 0, 1.55, 0, 1.16,0] #[-1.2, 0.2, 0  , 1.6, 0   , 1,     0] #Prepare original:funciona bien para pringles vertical (prisma vertical) 

PREPARE_TEST      = [-1.25, 0.3, 0, 2.4, 0, 0.7,0]
PREPARE_TOP_GRIP  = [-1.25, 0.3, 0, 2.4, 0, 0.7,0]
PREPARE_SERVING   = [0.91, 0.4, -0.5, 1.45, 0, 0.16, 0.5]
SERVING           = [0.91, 0.4, -0.5, 1.45, 0, 0.16, -1.6]
LEAVE_CEREAL      = [0.54, 0.28, -0.13, 1.45, 0, 0, 0]
LEAVE_MILK        = [0.44, 0.18, -0.03, 1.45, 0, 0, 0]
LEAVE_BOWL        = [0.6,  0.6, -0.8, 1.7, 0, 0.2, 0]
LEAVE_NEAR_CEREAL = [0.39, 0.18, -0.03, 1.45, 0, 0, 0]
EMPTYING_POSE     = [0.37, 0.57, -0.11, 1.68, -0.73, 0.76, -0.90]
LEAVE_NEAR_MILK   = [0.39, 0.18, -0.01, 1.42, 0, 0.37, 0]

PREPARE_RA    = [-0.8, -0.1, 0.0, 1.3, 1.3,0, 0.0]

GRIPER_MILK   = 0.0
GRIPER_CEREAL = 0.0
GRIPER_BOWL   = 0.0

MESA_INGREDIENTES ="ingredients_table" 
MESA_COMER        = "eat_table"

def serving_breakfast(object):
    print("PREPARE TOP")
    JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_TOP_GRIP, 10)
    time.sleep(0.5)
    JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_SERVING, 10)
    time.sleep(0.5)
    #JuskeshinoNavigation.moveDist(0.3, 7)      # mueve la base adelante con el brazo levantado y extendido
    if object =="milk": JuskeshinoHRI.say("Serving milk")
    else: JuskeshinoHRI.say("Serving cereal")
    JuskeshinoHardware.moveLeftArmWithTrajectory(SERVING, 10)
    time.sleep(2)
    JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_SERVING, 10)
    time.sleep(0.5)
    if object =="milk":
        JuskeshinoHardware.moveLeftArmWithTrajectory(LEAVE_MILK, 10)
        time.sleep(0.5)
        #JuskeshinoNavigation.moveDist(0.3, 7)
        JuskeshinoHardware.moveLeftGripper(0.7, 2.0)
        
    else:
        JuskeshinoNavigation.moveLateral(0.22, 10)
        JuskeshinoHardware.moveLeftArmWithTrajectory(LEAVE_CEREAL, 10)
        time.sleep(0.5)
        #JuskeshinoNavigation.moveDist(0.3, 7)
        #time.sleep(0.2)
        JuskeshinoHardware.moveLeftGripper(0.7, 2.0)



def main():
    print("INITIALIZING SERVE BREAKFAST 2024 TEST BY ITZEL..............ヾ(๑╹◡╹)ﾉ")
    rospy.init_node("serve_breakfast_test")
    rate = rospy.Rate(10)

    rospack = rospkg.RosPack()
    locations_default = rospack.get_path("config_files") + "/known_locations_objects.yaml"

    print(locations_default)
    #locations_default = rospack.get_path("config_files") + "/known_locations_simul.yaml"
    locations_file = rospy.get_param("~locations", locations_default)

    # Se subcribe a los servicios necesarios para manipulacion, navegacion,vision, etc...
    JuskeshinoNavigation.setNodeHandle()
    JuskeshinoVision.setNodeHandle()
    JuskeshinoHardware.setNodeHandle()
    JuskeshinoSimpleTasks.setNodeHandle()
    JuskeshinoHRI.setNodeHandle()
    JuskeshinoManipulation.setNodeHandle()
    JuskeshinoKnowledge.setNodeHandle()
    JuskeshinoKnowledge.loadLocations(locations_file)

    
    JuskeshinoHRI.say("I'm ready for the test")
    # Esperar a que se abra la puerta
    JuskeshinoHRI.say("I'm waiting for the door to be open")
    print(("I'm waiting for door open"))





    JuskeshinoHardware.moveTorso(0.1, 5.0)



    
    if not JuskeshinoSimpleTasks.waitForTheDoorToBeOpen(300):
        print("ACT-PLN.->Door never opened")
        return
    
    pila = ["bowl", "milk", "cereal", "spoon"] 

    #Inician acciones
    count = 0
    j = 0
    while count < 2: # Revisa pila
        print("OBJECT ACTUAL", pila[count])
        actual_obj = pila[count]
        # Ir a locacion de ingredientes
        JuskeshinoHRI.say("I'm going to the "+MESA_INGREDIENTES+" position.")
        print("I'm going to the "+MESA_INGREDIENTES+" position.")

        if not JuskeshinoNavigation.getClose(MESA_INGREDIENTES, 120):  #*******************
            print("SB-PLN.->Cannot get close to the "+MESA_INGREDIENTES+" position")
        time.sleep(1.3)

        # Apunta camara a la mesa
        print("SB-PLN.->move head")
        if not JuskeshinoHardware.moveHead(0,-1, 5):
            print("SB-PLN.->Cannot move head")
            time.sleep(1.0)
            JuskeshinoHardware.moveHead(0,-1, 5)
            time.sleep(1.0)
            JuskeshinoHardware.moveHead(0,-1, 5)
        JuskeshinoHRI.say("Align With the Table")
        time.sleep(1)
        # Alinearse con la mesa
        if not JuskeshinoSimpleTasks.alignWithTable():
            print("SB-PLN.->Cannot align with table")
            
        j=0 
        while j < 2:    #  Un agarre por cada brazo
            # Busqueda y reconocimiento del objeto
            JuskeshinoHRI.say("Trying to detect the object")
            [obj, img] = JuskeshinoSimpleTasks.object_search(actual_obj)   #**************************
            if obj == None: 
                JuskeshinoHRI.say("I couldn't find the object")
            else:   # Objeto detectado..................................................................................
                print("SB-PLN.->Detected object : " + str([obj.id, obj.category, obj.object_state, obj.pose.position]))
                JuskeshinoHRI.say("I found" + actual_obj)

                
                # El robot se mueve a la mejor mejor ubicacion de agarre
                print("SB-PLN.->handling location ")
                if (j > 0):
                    if (actual_obj == "spoon"):
                        print("spoon")
                        break
                    mov = JuskeshinoSimpleTasks.handling_location(obj, "ra")
                    # En la mejor ubicacion de agarre realiza de nuevo un reconocimiento del objeto***********************
                    print("SB-PLN.->Detected object : " + str([obj.id, obj.category, obj.object_state, obj.pose.position]))                        
                    # Tomar objeto                                             
                    print("SB-PLN.->Sending goal traj to prepare")

                    JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_RA, 10)  # prepare 
                    time.sleep(0.2)
                    print("SB-PLN.->Open gripper")
                    JuskeshinoHardware.moveRightGripper(0.7, 3.0)
                    print("SB-PLN.-> Call Best Grasping Configuration Service")
                    [resp, graspable] = JuskeshinoManipulation.GripLa(obj)
                    if graspable:
                        JuskeshinoHRI.say("graspable object")
                        print("SB-PLN.->object position", obj.pose.position)
                        JuskeshinoHardware.moveRightArmWithTrajectory(resp.articular_trajectory,10)
                        print("SB-PLN.->Closing gripper")
                        JuskeshinoHardware.moveRightGripper(0, 2.0) 
                        time.sleep(0.5)
                        print("ACT-PLN.->Moving arm to prepare***")
                        JuskeshinoHardware.moveRightArmWithTrajectory(PREPARE_RA, 10)  # prepare    
                        break
                    else:
                        JuskeshinoHRI.say("No possible poses found")
                        print("SB-PLN.->No possible poses found")

                else:
                    mov = JuskeshinoSimpleTasks.handling_location(obj, "la")
                    # En la mejor ubicacion de agarre realiza de nuevo un reconocimiento del objeto***********************
                    print("SB-PLN.->Detected object : " + str([obj.id, obj.category, obj.object_state, obj.pose.position]))                        
                    # Tomar objeto                                             
                    print("SB-PLN.->Sending goal traj to prepare")

                    JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_TOP_GRIP, 10)  # prepare 
                    time.sleep(0.2)
                    print("SB-PLN.->Open gripper")
                    if actual_obj == "bowl": JuskeshinoHardware.moveLeftGripper(0.4 , 3.0)
                    else: JuskeshinoHardware.moveLeftGripper(0.9, 3.0)

                    print("SB-PLN.-> Call Best Grasping Configuration Service")
                    [resp, graspable] = JuskeshinoManipulation.GripRa(obj)
                    if graspable:
                        JuskeshinoHRI.say("graspable object")
                        print("SB-PLN.->object position", obj.pose.position)
                        JuskeshinoHardware.moveLeftArmWithTrajectory(resp.articular_trajectory,10)
                        print("SB-PLN.->Closing gripper")
                        JuskeshinoHardware.moveLeftGripper(0, 2.0) 
                        time.sleep(0.5)
                        print("ACT-PLN.->Moving arm to prepare***")
                        JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_TOP_GRIP, 10)  # prepare    
                        break
                    else:
                        JuskeshinoHRI.say("No possible poses found")
                        print("SB-PLN.->No possible poses found")
            
            j = j + 1 
            actual_obj = pila[count+1]
        
        # Despues de que agarro el objeto va a la mesa del desayuno
        print("SB-PLN.->Moving base backwards")     # Se mueve hacia atras para planear la ruta a la mesa del desayuno
        #JuskeshinoHRI.say("I'have grasped the object")
        JuskeshinoNavigation.moveDist(-0.3, 10)
        time.sleep(0.5)
        count = count + 2          # Actualiza numero de veces que toma un objeto
        actual_obj = pila[count]    # Actualiza lista de objetos
        print("Actual object: ", actual_obj)    

        #.........................................................................................................................
        # Ir a la mesa del desayuno...............................................................................................
        #.........................................................................................................................
        
        # Navega hacia la segunda mesa
        print("SB-PLN.->Getting close to " + MESA_COMER + "location")
        JuskeshinoHRI.say("I'm going to the" + MESA_COMER + "location")
        if not JuskeshinoNavigation.getClose(MESA_COMER, 100):  #**********************************
        #if not JuskeshinoNavigation.getClose("cupboard", 100):
            print("SB-PLN.->Cannot get close to " + MESA_COMER +" position")
        JuskeshinoHRI.say("I have arrived at the" + MESA_COMER + " location")
        time.sleep(1)
        # Se alinea con la mesa
        print("SB-PLN.->move head")
        if not JuskeshinoHardware.moveHead(0,-1, 5):
            print("SB-PLN.->Cannot move head")
            time.sleep(0.5)
            JuskeshinoHardware.moveHead(0,-1, 5)
        time.sleep(1)
        JuskeshinoHRI.say("Aligning with table")
        print("SB-PLN.->Aligning with table")
        JuskeshinoSimpleTasks.alignWithTable()
    
        # Coloca objeto sobre la mesa
        print("SB-PLN.->Moving left arm to deliver position")
        JuskeshinoHRI.say("Leave object")
        if (actual_obj == "milk") or (actual_obj == "cereal"):
            time.sleep(1)
            print("SB-PLN.->Moving base backwards")
            serving_breakfast(actual_obj) 
        if actual_obj == "bowl":
            JuskeshinoHRI.say("prepare")
            JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_TOP_GRIP , 12) 
            time.sleep(0.5)
            JuskeshinoHRI.say("bowl")
            JuskeshinoHardware.moveLeftArmWithTrajectory(LEAVE_BOWL , 12)
            time.sleep(1)
            # se mueve hacia delante 0.3 m**********************************pendiente
            print("SB-PLN.->Moving base backwards")
            JuskeshinoHRI.say("I'm going to place the object on the table")
            JuskeshinoNavigation.moveDist(0.15, 7)
            # Soltar el objeto
            time.sleep(0.5)
            print("SB-PLN.->Open gripper")
            JuskeshinoHardware.moveLeftGripper(0.7, 2.0)
            time.sleep(1)            # Soltar el objeto

        print("SB-PLN.->Moving right arm to deliver position")
        JuskeshinoHRI.say("Leave objectwith right arm")
        if (actual_obj == "milk") or (actual_obj == "cereal"):
            time.sleep(1)
            print("SB-PLN.->Moving base backwards")
            serving_breakfast(actual_obj) 
        if actual_obj == "bowl":
            JuskeshinoHRI.say("prepare")
            JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE_TOP_GRIP , 12) 
            time.sleep(0.5)
            JuskeshinoHRI.say("bowl")
            JuskeshinoHardware.moveLeftArmWithTrajectory(LEAVE_BOWL , 12)
            time.sleep(1)
            # se mueve hacia delante 0.3 m**********************************pendiente
            print("SB-PLN.->Moving base backwards")
            JuskeshinoHRI.say("I'm going to place the object on the table")
            JuskeshinoNavigation.moveDist(0.15, 7)
            # Soltar el objeto
            time.sleep(0.5)
            print("SB-PLN.->Open gripper")
            JuskeshinoHardware.moveLeftGripper(0.7, 2.0)
            time.sleep(1)            # Soltar el objeto

            

        # Moverse para atras
        print("SB-PLN.->Moving base backwards")
        JuskeshinoNavigation.moveDist(-0.3, 7)
        time.sleep(0.5)
        print("SB-PLN.->Moving left arm to prepare")
        JuskeshinoHardware.moveLeftArmWithTrajectory(PREPARE , 10)
        time.sleep(0.5)
        JuskeshinoHardware.moveLeftArmWithTrajectory(HOME , 10)
        
        
    # El desayuno esta servido 
    JuskeshinoHRI.say("Breakfast is served. I finish the test")
    


    return 
    while not rospy.is_shutdown():
        rate.sleep()


if __name__ == "__main__":
    main()


	
